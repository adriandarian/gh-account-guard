#!/usr/bin/env bash
set -euo pipefail

# Get the directory where this script is located
# This allows the script to work when installed as a gh extension
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source all modules in dependency order
source "${SCRIPT_DIR}/lib/utils.sh"
source "${SCRIPT_DIR}/lib/ui.sh"
source "${SCRIPT_DIR}/lib/directory.sh"
source "${SCRIPT_DIR}/lib/helpers/yaml.sh"
source "${SCRIPT_DIR}/lib/helpers/git.sh"
source "${SCRIPT_DIR}/lib/helpers/gh_auth.sh"
source "${SCRIPT_DIR}/lib/helpers/profile.sh"
source "${SCRIPT_DIR}/lib/config.sh"
source "${SCRIPT_DIR}/lib/commands.sh"

usage() {
  cat <<'EOF'
gh account-guard <command>

Commands:
  setup                Interactive setup wizard to configure profiles
  init                 Create example config template at ~/.config/gh/account-guard.yml
  config               Manage extension settings (default directory, etc.)
  status               Show which profile matches CWD and current gh/git identity
  fix                  Apply matching profile to current repo (git config, signing)
  switch               Run `gh auth switch` to the matching profile
  install               Install shell hook and git pre-commit hook (recommended)
  create-alias         Create 'gh ag' alias for 'gh account-guard'
  install-shell-hook   Prints a shell snippet for auto-enforcement on directory change
  install-git-hook     Install a pre-commit hook (use --global for all repos)
  apply-hook-to-repos  Apply hook to all existing repos in configured paths
EOF
}

main() {
  sub="${1:-}"; shift || true
  case "$sub" in
  setup) cmd_setup "$@";;
  init) cmd_init "$@";;
  config) cmd_config "$@";;
  status) cmd_status "$@";;
  fix) cmd_fix "$@";;
  switch) cmd_switch "$@";;
  auto-enforce) cmd_auto_enforce "$@";;
  install) cmd_install "$@";;
  create-alias) cmd_create_alias "$@";;
  install-shell-hook) cmd_install_shell_hook "$@";;
  install-git-hook) cmd_install_git_hook "$@";;
  apply-hook-to-repos) cmd_apply_hook_to_existing_repos "$@";;
  ""|-h|--help|help) usage;;
  *) echo "Unknown command: $sub" >&2; usage; exit 1;;
  esac
}
main "$@"
